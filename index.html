<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Distribution Data Collection</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
        }
        input, button {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            cursor: pointer;
        }
        button:hover {
            background-color: #45a049;
        }
        .entry-section {
            margin-top: 20px;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>Distribution Data Collection</h1>
    <div class="form-group">
        <label for="officeCenter">कार्यालय संकुल केंद्र:</label>
        <input type="text" id="officeCenter" required>
    </div>
    <div class="form-group">
        <label for="schoolName">शाला:</label>
        <input type="text" id="schoolName" required>
    </div>
    <div class="form-group">
        <label for="headerDate">दिनांक (Header Date):</label>
        <input type="date" id="headerDate" required>
    </div>
    <div class="form-group">
        <label for="remainingQuantity">शेष (Remaining Quantity):</label>
        <input type="number" id="remainingQuantity" min="1" required>
    </div>
    <button onclick="initializeSession()">Start Data Collection</button>

    <div id="dataEntrySection" class="entry-section" style="display: none;">
        <div class="form-group">
            <label for="entryDate">दिनांक:</label>
            <input type="date" id="entryDate" required>
        </div>
        <div class="form-group">
            <label for="beneficiaryName">लाभान्वित विद्यार्थियों का नाम:</label>
            <input type="text" id="beneficiaryName" required>
        </div>
        <button onclick="addEntry()">Add Entry</button>
    </div>
    <button id="downloadButton" style="display: none;" onclick="downloadCSV()">Download CSV</button>

    <script>
        let dataCollection = [];
        let remainingQuantity = 0;

        function initializeSession() {
            const officeCenter = document.getElementById("officeCenter").value.trim();
            const schoolName = document.getElementById("schoolName").value.trim();
            const headerDate = document.getElementById("headerDate").value;
            remainingQuantity = parseInt(document.getElementById("remainingQuantity").value);

            if (!officeCenter || !schoolName || !headerDate || remainingQuantity <= 0) {
                alert("कृपया सभी फ़ील्ड सही तरीके से भरें।");
                return;
            }

            const sessionData = {
                officeCenter,
                schoolName,
                headerDate,
                remainingQuantity,
                entries: [],
            };
            localStorage.setItem("distributionSession", JSON.stringify(sessionData));
            loadSessionData();
        }

        function loadSessionData() {
            const sessionData = JSON.parse(localStorage.getItem("distributionSession"));
            if (sessionData) {
                dataCollection = sessionData.entries || [];
                remainingQuantity = sessionData.remainingQuantity;
                document.getElementById("dataEntrySection").style.display = "block";
                document.getElementById("downloadButton").style.display = "block";
            }
        }

        function addEntry() {
            const entryDate = document.getElementById("entryDate").value;
            const beneficiaryName = document.getElementById("beneficiaryName").value.trim();

            if (!entryDate || !beneficiaryName) {
                alert("कृपया दिनांक और लाभार्थी का नाम दर्ज करें।");
                return;
            }

            if (remainingQuantity <= 0) {
                alert("वितरण के लिए शेष मात्रा समाप्त हो गई है।");
                return;
            }

            const serialNumber = dataCollection.length + 1;
            dataCollection.push({
                serialNumber,
                entryDate,
                beneficiaryName,
                distributionAmount: 1,
                remaining: remainingQuantity,
            });

            remainingQuantity--;
            updateSession();
            alert("डेटा सफलतापूर्वक जोड़ा गया।");
        }

        function updateSession() {
            const sessionData = JSON.parse(localStorage.getItem("distributionSession"));
            sessionData.entries = dataCollection;
            sessionData.remainingQuantity = remainingQuantity;
            localStorage.setItem("distributionSession", JSON.stringify(sessionData));
        }

        function downloadCSV() {
            const sessionData = JSON.parse(localStorage.getItem("distributionSession"));
            if (!sessionData || dataCollection.length === 0) {
                alert("कोई डेटा उपलब्ध नहीं है।");
                return;
            }

            // Adding specific header rows as per the Python script
            let csvContent = `\t\tकार्यालय संकुल केंद्र - ${sessionData.officeCenter}\t\t\n`;
            csvContent += `\t\tशाला - ${sessionData.schoolName}\t\t\n`;
            csvContent += `\t\tमिलेट बार/सोयापिनेट चक्की /प्रोटीन बार /मोरेंगा बार की जानकारी (दिनांक - ${sessionData.headerDate} की स्थिति में)\t\t\n\n`;
            csvContent += `\t\tप्रपत्र -1\t\t\n\n`;
            csvContent += `\t\tशाला स्तर पर संधारित अभिलेख\t\t\n\n`;
            csvContent += "क्रमांक,दिनांक,लाभान्वित विद्यार्थियों का नाम,वितरण मात्रा,शेष\n";

            // Adding entry rows
            dataCollection.forEach((entry) => {
                csvContent += `${entry.serialNumber},${entry.entryDate},${entry.beneficiaryName},${entry.distributionAmount},${entry.remaining}\n`;
            });

            const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
            const link = document.createElement("a");
            const timestamp = new Date().toISOString().replace(/[:.]/g, "");
            link.href = URL.createObjectURL(blob);
            link.download = `distribution_data_${timestamp}.csv`;
            link.style.display = "none";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Load session data on page refresh
        window.onload = loadSessionData;
    </script>
</body>
</html>
